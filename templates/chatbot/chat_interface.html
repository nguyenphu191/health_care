{% extends 'base.html' %}

{% block title %}Trợ lý ảo - Health Care{% endblock %}

{% block content %}
<div class="row h-100">
    <div class="col-12">
        <div class="card h-100" style="min-height: 600px;">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="mb-0">Trợ lý ảo Healthcare</h5>
                        <small class="text-light">Luôn sẵn sàng hỗ trợ bạn 24/7</small>
                    </div>
                    <div class="ms-auto">
                        <button class="btn btn-outline-light btn-sm me-1" onclick="showDiseasePrediction()" title="Dự đoán bệnh">
                            <i class="fas fa-brain"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm me-1" onclick="clearChat()" title="Xóa lịch sử chat">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="toggleChatInfo()" title="Thông tin">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body d-flex flex-column p-0" style="height: 500px;">
                <!-- Chat messages area -->
                <div id="chatMessages" class="flex-grow-1 overflow-auto p-3" style="background-color: #f8f9fa;">
                    <!-- Welcome message -->
                    <div class="chat-message bot-message mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar me-2">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                    <i class="fas fa-robot text-white"></i>
                                </div>
                            </div>
                            <div class="message-content">
                                <div class="bg-white rounded p-3 shadow-sm">
                                    <p class="mb-0">
                                        Xin chào! Tôi là trợ lý ảo của hệ thống chăm sóc sức khỏe. 
                                        Tôi có thể giúp bạn đặt lịch hẹn, dự đoán bệnh từ triệu chứng, và trả lời các câu hỏi về y tế.
                                    </p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> Vừa xong
                                    </small>
                                </div>
                                <div class="quick-replies mt-2">
                                    <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickMessage('Đặt lịch hẹn')">
                                        <i class="fas fa-calendar-plus"></i> Đặt lịch hẹn
                                    </button>
                                    <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="sendQuickMessage('Dự đoán bệnh')">
                                        <i class="fas fa-brain"></i> Dự đoán bệnh
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="sendQuickMessage('Tư vấn triệu chứng')">
                                        <i class="fas fa-stethoscope"></i> Tư vấn triệu chứng
                                    </button>
                                    <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="sendQuickMessage('Câu hỏi thường gặp')">
                                        <i class="fas fa-question-circle"></i> FAQ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Typing indicator -->
                <div id="typingIndicator" class="px-3 py-2" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="avatar me-2">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                        </div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Message input area -->
                <div class="border-top p-3">
                    <form id="chatForm" class="d-flex align-items-center">
                        <div class="flex-grow-1 me-2">
                            <input type="text" 
                                   id="messageInput" 
                                   class="form-control" 
                                   placeholder="Nhập tin nhắn của bạn..." 
                                   autocomplete="off"
                                   maxlength="1000">
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <!-- Quick action buttons -->
                    <div class="mt-2">
                        <button class="btn btn-outline-primary btn-sm me-1" onclick="showDiseasePrediction()">
                            <i class="fas fa-brain"></i> Dự đoán bệnh
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-1" onclick="showEmergencyInfo()">
                            <i class="fas fa-exclamation-triangle text-danger"></i> Cấp cứu
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-1" onclick="showDoctorsList()">
                            <i class="fas fa-user-md"></i> Danh sách BS
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="provideFeedback()">
                            <i class="fas fa-star"></i> Đánh giá
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disease Prediction Modal -->
<div class="modal fade" id="diseasePredictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain text-primary"></i> Dự đoán bệnh thông minh
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Lưu ý:</strong> Đây chỉ là công cụ hỗ trợ, không thay thế chẩn đoán của bác sĩ.
                </div>
                
                <!-- Symptom Selection -->
                <div id="symptomSelection">
                    <h6>Chọn các triệu chứng bạn đang gặp phải:</h6>
                    <div id="symptomCategories">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="mt-3">
                        <h6>Triệu chứng đã chọn:</h6>
                        <div id="selectedSymptoms" class="border rounded p-2 bg-light">
                            <span class="text-muted">Chưa chọn triệu chứng nào</span>
                        </div>
                    </div>
                </div>
                
                <!-- Prediction Results -->
                <div id="predictionResults" style="display: none;">
                    <h6>Kết quả dự đoán:</h6>
                    <div id="predictionContent"></div>
                    
                    <!-- Feedback Section -->
                    <div class="mt-3">
                        <h6>Đánh giá kết quả:</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="submitPredictionFeedback('helpful')">
                                <i class="fas fa-thumbs-up"></i> Hữu ích
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="submitPredictionFeedback('somewhat')">
                                <i class="fas fa-meh"></i> Tạm được
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="submitPredictionFeedback('not_helpful')">
                                <i class="fas fa-thumbs-down"></i> Không hữu ích
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="predictDiseaseBtn" onclick="performDiseasePrediction()">
                    <i class="fas fa-search"></i> Dự đoán bệnh
                </button>
                <button type="button" class="btn btn-success" id="bookAppointmentBtn" style="display: none;" onclick="bookAppointmentFromPrediction()">
                    <i class="fas fa-calendar-plus"></i> Đặt lịch hẹn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Info Modal -->
<div class="modal fade" id="chatInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Thông tin trợ lý ảo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Tôi có thể giúp bạn:</h6>
                <ul>
                    <li>🗓️ Đặt lịch hẹn với bác sĩ</li>
                    <li>🧠 Dự đoán bệnh từ triệu chứng</li>
                    <li>🩺 Tư vấn triệu chứng sức khỏe cơ bản</li>
                    <li>❓ Trả lời câu hỏi về y tế</li>
                    <li>🏥 Hướng dẫn sử dụng hệ thống</li>
                    <li>🚨 Thông tin cấp cứu</li>
                </ul>
                
                <div class="alert alert-warning">
                    <strong>Lưu ý:</strong> Thông tin từ chatbot chỉ mang tính tham khảo. 
                    Vui lòng tham khảo ý kiến bác sĩ để được chẩn đoán và điều trị chính xác.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-star"></i> Đánh giá trợ lý ảo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <div class="mb-3">
                        <label class="form-label">Đánh giá của bạn:</label>
                        <div class="rating-stars">
                            <input type="radio" name="rating" value="5" id="star5">
                            <label for="star5">⭐</label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4">⭐</label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3">⭐</label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2">⭐</label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1">⭐</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ý kiến đóng góp:</label>
                        <textarea class="form-control" name="comment" rows="3" 
                                  placeholder="Chia sẻ ý kiến của bạn về trợ lý ảo..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()">Gửi đánh giá</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Chat message styles */
.chat-message {
    animation: fadeInUp 0.3s ease-out;
}

.user-message .message-content {
    text-align: right;
}

.user-message .bg-primary {
    color: white;
}

.quick-replies .btn {
    transition: all 0.2s ease;
}

.quick-replies .btn:hover {
    transform: translateY(-1px);
}

/* Disease Prediction Styles */
.symptom-category {
    margin-bottom: 20px;
}

.symptom-item {
    display: inline-block;
    margin: 3px;
}

.selected-symptom {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 15px;
    font-size: 0.875rem;
}

.prediction-result {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.prediction-high {
    border-left: 4px solid #28a745;
}

.prediction-medium {
    border-left: 4px solid #ffc107;
}

.prediction-low {
    border-left: 4px solid #dc3545;
}

.confidence-badge {
    font-size: 0.875rem;
    padding: 4px 8px;
}

/* Typing indicator */
.typing-dots {
    display: inline-flex;
    align-items: center;
}

.typing-dots span {
    height: 8px;
    width: 8px;
    background-color: #007bff;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing 1.4s infinite both;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Rating stars */
.rating-stars {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating-stars input {
    display: none;
}

.rating-stars label {
    font-size: 1.5rem;
    cursor: pointer;
    transition: color 0.2s;
}

.rating-stars label:hover,
.rating-stars label:hover ~ label,
.rating-stars input:checked ~ label {
    color: #ffc107;
}

/* Scrollbar */
#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
// Global variables
let currentSessionId = null;
let isWaitingForResponse = false;
let selectedSymptoms = [];
let currentPredictionId = null;
let symptomsData = {};

// Initialize chat when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadChatHistory();
    
    // Focus on input
    document.getElementById('messageInput').focus();
    
    // Handle form submission
    document.getElementById('chatForm').addEventListener('submit', handleMessageSubmit);
    
    // Handle Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleMessageSubmit(e);
        }
    });
});

// Handle message submission
function handleMessageSubmit(e) {
    e.preventDefault();
    
    if (isWaitingForResponse) {
        return;
    }
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) {
        return;
    }
    
    // Clear input
    messageInput.value = '';
    
    // Add user message to chat
    addMessageToChat('user', message);
    
    // Send to backend
    sendMessageToBot(message);
}

// Add message to chat interface
function addMessageToChat(sender, content, metadata = {}) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message mb-3`;
    
    const timestamp = new Date().toLocaleTimeString('vi-VN', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start justify-content-end">
                <div class="message-content">
                    <div class="bg-primary text-white rounded p-3 shadow-sm">
                        <p class="mb-0">${content}</p>
                        <small class="text-light">
                            <i class="fas fa-clock"></i> ${timestamp}
                        </small>
                    </div>
                </div>
                <div class="avatar ms-2">
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                </div>
            </div>
        `;
    } else {
        let quickRepliesHtml = '';
        if (metadata.quick_replies && metadata.quick_replies.length > 0) {
            quickRepliesHtml = '<div class="quick-replies mt-2">';
            metadata.quick_replies.forEach(reply => {
                quickRepliesHtml += `<button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="sendQuickMessage('${reply}')">${reply}</button>`;
            });
            quickRepliesHtml += '</div>';
        }
        
        // Special handling for disease prediction
        let specialContent = '';
        if (metadata.action === 'show_symptom_selector') {
            specialContent = '<button class="btn btn-primary btn-sm mt-2" onclick="showDiseasePrediction()"><i class="fas fa-brain"></i> Chọn triệu chứng</button>';
        }
        
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="avatar me-2">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                </div>
                <div class="message-content">
                    <div class="bg-white rounded p-3 shadow-sm">
                        <p class="mb-0">${content.replace(/\n/g, '<br>')}</p>
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${timestamp}
                        </small>
                    </div>
                    ${specialContent}
                    ${quickRepliesHtml}
                </div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

// Send message to bot
async function sendMessageToBot(message) {
    if (isWaitingForResponse) return;
    
    isWaitingForResponse = true;
    showTypingIndicator();
    
    try {
        const response = await fetch('{% url "chatbot:chat_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentSessionId = data.session_id;
            hideTypingIndicator();
            
            // Add bot response
            addMessageToChat('bot', data.bot_message.content, data.bot_message.metadata);
            
        } else {
            hideTypingIndicator();
            addMessageToChat('bot', 'Xin lỗi, có lỗi xảy ra. Vui lòng thử lại.');
        }
        
    } catch (error) {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessageToChat('bot', 'Không thể kết nối đến server. Vui lòng thử lại.');
    }
    
    isWaitingForResponse = false;
}

// Send quick message
function sendQuickMessage(message) {
    if (isWaitingForResponse) return;
    
    // Handle special messages
    if (message === 'Dự đoán bệnh') {
        showDiseasePrediction();
        return;
    }
    
    addMessageToChat('user', message);
    sendMessageToBot(message);
}

// Disease Prediction Functions
function showDiseasePrediction() {
    const modal = new bootstrap.Modal(document.getElementById('diseasePredictionModal'));
    modal.show();
    loadSymptoms();
}

async function loadSymptoms() {
    try {
        const response = await fetch('{% url "chatbot:disease_prediction" %}');
        const data = await response.json();
        
        if (data.symptoms_by_category) {
            symptomsData = data.symptoms_by_category;
            renderSymptomCategories();
        }
    } catch (error) {
        console.error('Error loading symptoms:', error);
        alert('Không thể tải danh sách triệu chứng');
    }
}

function renderSymptomCategories() {
    const container = document.getElementById('symptomCategories');
    container.innerHTML = '';
    
    for (const [category, symptoms] of Object.entries(symptomsData)) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'symptom-category';
        
        let html = `<h6 class="text-primary">${category}</h6><div class="row">`;
        
        symptoms.forEach(symptom => {
            html += `
                <div class="col-md-6 symptom-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${symptom.name}" 
                               id="symptom_${symptom.id}" onchange="toggleSymptom('${symptom.name}')">
                        <label class="form-check-label" for="symptom_${symptom.id}" title="${symptom.description}">
                            ${symptom.name}
                        </label>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        categoryDiv.innerHTML = html;
        container.appendChild(categoryDiv);
    }
}

function toggleSymptom(symptomName) {
    const index = selectedSymptoms.indexOf(symptomName);
    if (index > -1) {
        selectedSymptoms.splice(index, 1);
    } else {
        selectedSymptoms.push(symptomName);
    }
    updateSelectedSymptomsDisplay();
}

function updateSelectedSymptomsDisplay() {
    const container = document.getElementById('selectedSymptoms');
    
    if (selectedSymptoms.length === 0) {
        container.innerHTML = '<span class="text-muted">Chưa chọn triệu chứng nào</span>';
    } else {
        let html = '';
        selectedSymptoms.forEach(symptom => {
            html += `<span class="selected-symptom">${symptom} <i class="fas fa-times" onclick="removeSymptom('${symptom}')" style="cursor: pointer;"></i></span>`;
        });
        container.innerHTML = html;
    }
    
    // Enable/disable predict button
    document.getElementById('predictDiseaseBtn').disabled = selectedSymptoms.length === 0;
}

function removeSymptom(symptomName) {
    const checkbox = document.querySelector(`input[value="${symptomName}"]`);
    if (checkbox) {
        checkbox.checked = false;
    }
    toggleSymptom(symptomName);
}

async function performDiseasePrediction() {
    if (selectedSymptoms.length === 0) {
        alert('Vui lòng chọn ít nhất một triệu chứng');
        return;
    }
    
    const predictBtn = document.getElementById('predictDiseaseBtn');
    predictBtn.disabled = true;
    predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang dự đoán...';
    
    try {
        const response = await fetch('{% url "chatbot:disease_prediction" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                symptoms: selectedSymptoms
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentPredictionId = data.prediction_id;
            displayPredictionResults(data);
        } else {
            alert(data.message || 'Có lỗi xảy ra trong quá trình dự đoán');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Không thể kết nối đến server');
    } finally {
        predictBtn.disabled = false;
        predictBtn.innerHTML = '<i class="fas fa-search"></i> Dự đoán bệnh';
    }
}

function displayPredictionResults(data) {
    const resultsContainer = document.getElementById('predictionResults');
    const contentContainer = document.getElementById('predictionContent');
    
    let html = '';
    
    if (data.predictions && data.predictions.length > 0) {
        data.predictions.forEach((pred, index) => {
            const confidenceClass = pred.confidence === 'high' ? 'prediction-high' : 
                                  pred.confidence === 'medium' ? 'prediction-medium' : 'prediction-low';
            const confidenceColor = pred.confidence === 'high' ? 'success' : 
                                   pred.confidence === 'medium' ? 'warning' : 'danger';
            
            html += `
                <div class="prediction-result ${confidenceClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${index + 1}. ${pred.disease}</h6>
                            <div class="mb-2">
                                <span class="badge bg-${confidenceColor} confidence-badge">
                                    Xác suất: ${(pred.probability * 100).toFixed(1)}%
                                </span>
                                <span class="badge bg-secondary confidence-badge">
                                    ${pred.confidence === 'high' ? 'Độ tin cậy cao' : 
                                      pred.confidence === 'medium' ? 'Độ tin cậy trung bình' : 'Độ tin cậy thấp'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Overall confidence
        const overallConfidence = data.confidence_score;
        const confidenceText = overallConfidence > 0.7 ? 'Cao' : overallConfidence > 0.4 ? 'Trung bình' : 'Thấp';
        const confidenceColor = overallConfidence > 0.7 ? 'success' : overallConfidence > 0.4 ? 'warning' : 'danger';
        
        html += `
            <div class="alert alert-${confidenceColor}">
                <strong>Độ tin cậy tổng thể: ${confidenceText} (${(overallConfidence * 100).toFixed(1)}%)</strong>
                <br>
                <small>⚠️ Kết quả này chỉ mang tính tham khảo. Vui lòng đặt lịch khám với bác sĩ để được chẩn đoán chính xác.</small>
            </div>
        `;
    } else {
        html = '<div class="alert alert-warning">Không thể xác định bệnh cụ thể với các triệu chứng đã chọn.</div>';
    }
    
    contentContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
    
    // Show book appointment button
    document.getElementById('bookAppointmentBtn').style.display = 'inline-block';
    
    // Add to chat
    addPredictionToChat(data);
}

function addPredictionToChat(data) {
    const message = `🔍 **Kết quả dự đoán bệnh:**\n\n${data.message}`;
    addMessageToChat('bot', message, {
        prediction_result: true,
        prediction_id: data.prediction_id,
        quick_replies: ['Đặt lịch hẹn', 'Dự đoán lại', 'Hỏi bác sĩ']
    });
}

async function submitPredictionFeedback(feedbackType) {
    if (!currentPredictionId) return;
    
    try {
        const response = await fetch('{% url "chatbot:prediction_feedback" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                prediction_id: currentPredictionId,
                feedback_type: feedbackType
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Cảm ơn bạn đã đóng góp ý kiến!');
        }
    } catch (error) {
        console.error('Error submitting feedback:', error);
    }
}

function bookAppointmentFromPrediction() {
    // Hide modal and redirect to booking
    const modal = bootstrap.Modal.getInstance(document.getElementById('diseasePredictionModal'));
    modal.hide();
    
    addMessageToChat('user', 'Đặt lịch hẹn');
    sendMessageToBot('Đặt lịch hẹn');
}

// Other utility functions
function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
    scrollToBottom();
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function loadChatHistory() {
    try {
        const response = await fetch('{% url "chatbot:chat_history" %}');
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            // Clear welcome message
            document.getElementById('chatMessages').innerHTML = '';
            
            data.messages.forEach(msg => {
                if (msg.sender !== 'system') {
                    addMessageToChat(msg.sender, msg.content, msg.metadata);
                }
            });
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
    }
}

function clearChat() {
    if (confirm('Bạn có muốn xóa toàn bộ lịch sử chat không?')) {
        location.reload();
    }
}

function toggleChatInfo() {
    const modal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
    modal.show();
}

function showEmergencyInfo() {
    sendQuickMessage('Cấp cứu');
}

function showDoctorsList() {
    sendQuickMessage('Danh sách bác sĩ');
}

function provideFeedback() {
    if (!currentSessionId) {
        alert('Vui lòng chat với bot trước khi đánh giá.');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    modal.show();
}

async function submitFeedback() {
    const rating = document.querySelector('input[name="rating"]:checked');
    const comment = document.querySelector('textarea[name="comment"]').value;
    
    if (!rating) {
        alert('Vui lòng chọn đánh giá sao.');
        return;
    }
    
    try {
        const response = await fetch('{% url "chatbot:chat_feedback" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: currentSessionId,
                rating: rating.value,
                comment: comment
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Cảm ơn bạn đã đóng góp ý kiến!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('feedbackForm').reset();
        }
        
    } catch (error) {
        console.error('Error submitting feedback:', error);
        alert('Có lỗi xảy ra khi gửi đánh giá.');
    }
}

// Reset modals when closed
document.getElementById('diseasePredictionModal').addEventListener('hidden.bs.modal', function() {
    selectedSymptoms = [];
    currentPredictionId = null;
    document.getElementById('predictionResults').style.display = 'none';
    document.getElementById('bookAppointmentBtn').style.display = 'none';
    updateSelectedSymptomsDisplay();
    
    // Uncheck all checkboxes
    document.querySelectorAll('#symptomCategories input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
});

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}