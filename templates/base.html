<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Health Care System{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-heartbeat"></i> Health Care
            </a>
            
            <div class="navbar-nav ms-auto">
                {% if user.is_authenticated %}
                    <!-- Admin dropdown menu -->
                    {% if user.is_superuser %}
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-tachometer-alt"></i> Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'admin_dashboard' %}">
                                    <i class="fas fa-home"></i> Dashboard
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'manage_doctors' %}">
                                    <i class="fas fa-user-md"></i> Qu·∫£n l√Ω b√°c sƒ©
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'manage_patients' %}">
                                    <i class="fas fa-users"></i> Qu·∫£n l√Ω b·ªánh nh√¢n
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'admin_create_doctor' %}">
                                    <i class="fas fa-plus"></i> T·∫°o t√†i kho·∫£n BS
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'admin_create_patient' %}">
                                    <i class="fas fa-plus"></i> T·∫°o t√†i kho·∫£n BN
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'chatbot:admin_dashboard' %}">
                                    <i class="fas fa-robot"></i> Qu·∫£n l√Ω Chatbot
                                </a></li>
                                <li><a class="dropdown-item" href="/admin/" target="_blank">
                                    <i class="fas fa-cogs"></i> Django Admin
                                </a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a>
                    {% endif %}
                    
                    {% if user.user_type == 'doctor' %}
                        <a class="nav-link" href="{% url 'doctor_appointments' %}">L·ªãch h·∫πn</a>
                        <a class="nav-link" href="{% url 'doctor_schedule' %}">L·ªãch l√†m vi·ªác</a>
                    {% elif user.user_type == 'patient' %}
                        <a class="nav-link" href="{% url 'book_appointment' %}">ƒê·∫∑t l·ªãch</a>
                        <a class="nav-link" href="{% url 'patient_appointments' %}">L·ªãch h·∫πn c·ªßa t√¥i</a>
                    {% endif %}
                    
                    <a class="nav-link" href="{% url 'qa_list' %}">H·ªèi ƒë√°p</a>
                    
                    <!-- Chatbot link in navbar -->
                    <a class="nav-link" href="{% url 'chatbot:chat_interface' %}" title="Tr·ª£ l√Ω ·∫£o">
                        <i class="fas fa-robot"></i> Tr·ª£ l√Ω ·∫£o
                    </a>
                    
                    <!-- User dropdown menu -->
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> {{ user.first_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            {% if not user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'edit_profile' %}">
                                    <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a th√¥ng tin
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </div>
                {% else %}
                    <a class="nav-link" href="{% url 'login' %}">ƒêƒÉng nh·∫≠p</a>
                    <a class="nav-link" href="{% url 'doctor_register' %}">ƒêƒÉng k√Ω BS</a>
                    <a class="nav-link" href="{% url 'patient_register' %}">ƒêƒÉng k√Ω BN</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chatbot Widget -->
    {% if user.is_authenticated %}
    <div id="chatbotWidget" class="chatbot-widget">
        <div class="chatbot-toggle" onclick="toggleChatbot()" id="chatbotToggle">
            <i class="fas fa-robot"></i>
            <span class="chat-notification" id="chatNotification" style="display: none;">1</span>
        </div>
        
        <div class="chatbot-container" id="chatbotContainer" style="display: none;">
            <div class="chatbot-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2"></i>
                    <div>
                        <span class="fw-bold">Tr·ª£ l√Ω ·∫£o</span>
                        <br>
                        <small class="text-light opacity-75">Lu√¥n s·∫µn s√†ng h·ªó tr·ª£</small>
                    </div>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="openFullChat()" title="M·ªü c·ª≠a s·ªï chat ƒë·∫ßy ƒë·ªß">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="toggleChatbot()" title="ƒê√≥ng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chatbot-messages" id="widgetMessages">
                <div class="bot-message">
                    <div class="d-flex align-items-start mb-2">
                        <div class="bot-avatar me-2">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble bot-bubble">
                                Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? üòä
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-clock"></i> V·ª´a xong
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input">
                <form id="widgetChatForm" class="d-flex align-items-center">
                    <input type="text" 
                           id="widgetMessageInput" 
                           class="form-control form-control-sm" 
                           placeholder="Nh·∫≠p tin nh·∫Øn..." 
                           autocomplete="off"
                           maxlength="500">
                    <button type="submit" class="btn btn-primary btn-sm ms-2" id="widgetSendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
            
            <div class="chatbot-quick-actions p-2">
                <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-outline-primary btn-sm flex-fill" onclick="sendWidgetMessage('ƒê·∫∑t l·ªãch h·∫πn')" style="font-size: 0.75rem;">
                        <i class="fas fa-calendar"></i> ƒê·∫∑t l·ªãch
                    </button>
                    <button class="btn btn-outline-success btn-sm flex-fill" onclick="sendWidgetMessage('T∆∞ v·∫•n tri·ªáu ch·ª©ng')" style="font-size: 0.75rem;">
                        <i class="fas fa-stethoscope"></i> T∆∞ v·∫•n
                    </button>
                </div>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    <button class="btn btn-outline-info btn-sm flex-fill" onclick="sendWidgetMessage('C√¢u h·ªèi th∆∞·ªùng g·∫∑p')" style="font-size: 0.75rem;">
                        <i class="fas fa-question-circle"></i> FAQ
                    </button>
                    <button class="btn btn-outline-danger btn-sm flex-fill" onclick="sendWidgetMessage('C·∫•p c·ª©u')" style="font-size: 0.75rem;">
                        <i class="fas fa-exclamation-triangle"></i> C·∫•p c·ª©u
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <style>
    /* Chatbot Widget Styles */
    .chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .chatbot-toggle {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 3px solid white;
    }

    .chatbot-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.5);
    }

    .chatbot-toggle.active {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .chat-notification {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .chatbot-container {
        position: absolute;
        bottom: 75px;
        right: 0;
        width: 380px;
        height: 520px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        overflow: hidden;
        border: 1px solid rgba(0, 123, 255, 0.1);
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .chatbot-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 20px 20px 0 0;
    }

    .chatbot-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        scroll-behavior: smooth;
    }

    .chatbot-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chatbot-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 123, 255, 0.3);
        border-radius: 3px;
    }

    .chatbot-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 123, 255, 0.5);
    }

    .bot-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #28a745, #20c997);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
    }

    .message-bubble {
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 260px;
        word-wrap: break-word;
        line-height: 1.4;
        font-size: 14px;
    }

    .bot-bubble {
        background: white;
        color: #333;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 123, 255, 0.1);
    }

    .user-bubble {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        margin-left: auto;
        box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
    }

    .user-message {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 16px;
    }

    .user-message .message-content {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .bot-message .message-content {
        flex: 1;
    }

    .chatbot-input {
        padding: 16px;
        background: white;
        border-top: 1px solid #e9ecef;
    }

    .chatbot-quick-actions {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: white;
        border-radius: 18px;
        margin-bottom: 16px;
        max-width: 80px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #007bff;
        animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingAnimation {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.4;
        }
        30% {
            transform: translateY(-8px);
            opacity: 1;
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .chatbot-widget {
            bottom: 15px;
            right: 15px;
        }
        
        .chatbot-container {
            width: 320px;
            height: 480px;
            right: -20px;
        }
        
        .chatbot-toggle {
            width: 55px;
            height: 55px;
            font-size: 22px;
        }
        
        .message-bubble {
            max-width: 220px;
            font-size: 13px;
        }
    }

    @media (max-width: 480px) {
        .chatbot-container {
            width: 300px;
            height: 450px;
            right: -25px;
        }
        
        .message-bubble {
            max-width: 200px;
        }
    }

    /* Animation for new messages */
    .message-enter {
        animation: messageEnter 0.3s ease-out;
    }

    @keyframes messageEnter {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    </style>

    <script>
    // Chatbot Widget JavaScript
    let widgetIsOpen = false;
    let widgetSessionId = null;
    let isWaitingForResponse = false;

    function toggleChatbot() {
        const container = document.getElementById('chatbotContainer');
        const toggle = document.getElementById('chatbotToggle');
        
        if (widgetIsOpen) {
            container.style.display = 'none';
            toggle.classList.remove('active');
            toggle.innerHTML = '<i class="fas fa-robot"></i>';
            widgetIsOpen = false;
            
            // Hide notification when closing
            document.getElementById('chatNotification').style.display = 'none';
        } else {
            container.style.display = 'flex';
            toggle.classList.add('active');
            toggle.innerHTML = '<i class="fas fa-times"></i>';
            widgetIsOpen = true;
            
            // Focus v√†o input
            setTimeout(() => {
                const input = document.getElementById('widgetMessageInput');
                if (input) input.focus();
            }, 100);
        }
    }

    function openFullChat() {
        window.open('/chatbot/', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
    }

    function addMessageToWidget(sender, content, isTyping = false) {
        const messagesContainer = document.getElementById('widgetMessages');
        
        if (isTyping) {
            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
        } else {
            // Remove typing indicator
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `${sender}-message message-enter`;
            
            const timestamp = new Date().toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble user-bubble">
                            ${content}
                        </div>
                        <small class="text-muted d-block mt-1" style="text-align: right;">
                            <i class="fas fa-clock"></i> ${timestamp}
                        </small>
                    </div>
                    <div class="user-avatar ms-2">
                        <i class="fas fa-user"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start mb-2">
                        <div class="bot-avatar me-2">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble bot-bubble">
                                ${content.replace(/\n/g, '<br>')}
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-clock"></i> ${timestamp}
                            </small>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }
        
        // Scroll to bottom with smooth animation
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendWidgetMessage(message) {
        if (isWaitingForResponse || !message.trim()) return;
        
        // Add user message
        addMessageToWidget('user', message);
        
        // Show typing indicator
        addMessageToWidget('bot', '', true);
        
        isWaitingForResponse = true;
        
        // Disable input and button
        const input = document.getElementById('widgetMessageInput');
        const button = document.getElementById('widgetSendBtn');
        input.disabled = true;
        button.disabled = true;
        
        // Send to API
        fetch('/chatbot/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                widgetSessionId = data.session_id;
                addMessageToWidget('bot', data.bot_message.content);
                
                // Show notification if widget is closed
                if (!widgetIsOpen) {
                    const notification = document.getElementById('chatNotification');
                    notification.style.display = 'block';
                }
            } else {
                addMessageToWidget('bot', 'Xin l·ªói, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        })
        .catch(error => {
            console.error('Chatbot Error:', error);
            addMessageToWidget('bot', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.');
        })
        .finally(() => {
            isWaitingForResponse = false;
            input.disabled = false;
            button.disabled = false;
            input.focus();
        });
    }

    // Initialize chatbot widget
    document.addEventListener('DOMContentLoaded', function() {
        const widgetForm = document.getElementById('widgetChatForm');
        const widgetInput = document.getElementById('widgetMessageInput');
        
        if (widgetForm) {
            widgetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = widgetInput.value.trim();
                
                if (message) {
                    sendWidgetMessage(message);
                    widgetInput.value = '';
                }
            });
        }
        
        // Handle Enter key
        if (widgetInput) {
            widgetInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    widgetForm.dispatchEvent(new Event('submit'));
                }
            });
        }
        
        // Auto-focus when opening widget
        const chatbotToggle = document.getElementById('chatbotToggle');
        if (chatbotToggle) {
            chatbotToggle.addEventListener('click', function() {
                if (!widgetIsOpen) {
                    setTimeout(() => {
                        widgetInput?.focus();
                    }, 300);
                }
            });
        }
        
        // Close widget when clicking outside
        document.addEventListener('click', function(e) {
            const widget = document.getElementById('chatbotWidget');
            if (widgetIsOpen && widget && !widget.contains(e.target)) {
                // Don't auto-close, let user manually close
                // toggleChatbot();
            }
        });
    });

    // Add some friendly interactions
    function showWelcomeMessage() {
        if (!localStorage.getItem('chatbot_welcomed')) {
            setTimeout(() => {
                const notification = document.getElementById('chatNotification');
                if (notification) {
                    notification.style.display = 'block';
                    notification.textContent = '!';
                }
                localStorage.setItem('chatbot_welcomed', 'true');
            }, 3000);
        }
    }

   
    </script>
</body>
</html>