{% extends 'base.html' %}

{% block title %}Dashboard Bệnh nhân{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Chào mừng, {{ patient.user.get_full_name }}</h2>
                <p class="text-muted">Dashboard dành cho bệnh nhân</p>
            </div>
            <div>
                <a href="{% url 'chatbot:chat_interface' %}" class="btn btn-primary">
                    <i class="fas fa-robot"></i> Trợ lý ảo
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt fa-2x me-3"></i>
                    <div>
                        <h5 class="card-title">{{ upcoming_appointments }}</h5>
                        <p class="card-text">Lịch hẹn sắp tới</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-question-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="card-title">{{ questions.count }}</h5>
                        <p class="card-text">Câu hỏi đã đặt</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-brain fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">Dự đoán bệnh</h6>
                        <button class="btn btn-light btn-sm" onclick="openDiseasePrediction()">
                            <i class="fas fa-search"></i> Thử ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-plus-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="card-title">Đặt lịch mới</h6>
                        <a href="{% url 'book_appointment' %}" class="btn btn-light btn-sm">Đặt ngay</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    <!-- Recent Appointments -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-calendar-check"></i> Lịch hẹn gần đây</h5>
                <a href="{% url 'patient_appointments' %}" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
            </div>
            <div class="card-body">
                {% if appointments %}
                    <div class="list-group list-group-flush">
                        {% for appointment in appointments %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ appointment.doctor.user.get_full_name }}</h6>
                                    <p class="mb-1 text-muted">
                                        <i class="fas fa-calendar"></i> {{ appointment.appointment_date|date:"d/m/Y" }}
                                        <i class="fas fa-clock ms-2"></i> {{ appointment.appointment_time|time:"H:i" }}
                                    </p>
                                    <small class="text-muted">{{ appointment.symptoms|truncatewords:8 }}</small>
                                </div>
                                <div class="ms-2">
                                    {% if appointment.status == 'pending' %}
                                        <span class="badge bg-warning">{{ appointment.get_status_display }}</span>
                                    {% elif appointment.status == 'confirmed' %}
                                        <span class="badge bg-info">{{ appointment.get_status_display }}</span>
                                    {% elif appointment.status == 'completed' %}
                                        <span class="badge bg-success">{{ appointment.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ appointment.get_status_display }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có lịch hẹn nào.</p>
                        <a href="{% url 'book_appointment' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Đặt lịch hẹn đầu tiên
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Questions & AI Features -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-robot"></i> Tính năng AI & Hỏi đáp</h5>
                <a href="{% url 'qa_list' %}" class="btn btn-sm btn-outline-success">Xem tất cả</a>
            </div>
            <div class="card-body">
                <!-- AI Features -->
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="card bg-light h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                <h6 class="card-title">Dự đoán bệnh AI</h6>
                                <button class="btn btn-primary btn-sm" onclick="openDiseasePrediction()">
                                    Thử ngay
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-robot fa-2x text-success mb-2"></i>
                                <h6 class="card-title">Trợ lý ảo</h6>
                                <a href="{% url 'chatbot:chat_interface' %}" class="btn btn-success btn-sm">
                                    Chat ngay
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Questions -->
                {% if questions %}
                    <h6 class="mb-3">Câu hỏi gần đây:</h6>
                    <div class="list-group list-group-flush">
                        {% for question in questions %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ question.title|truncatechars:40 }}</h6>
                                    <p class="mb-1 small text-muted">{{ question.content|truncatewords:8 }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ question.created_at|timesince }} trước
                                    </small>
                                </div>
                                {% if question.answers.count > 0 %}
                                    <span class="badge bg-success">{{ question.answers.count }} trả lời</span>
                                {% else %}
                                    <span class="badge bg-warning">Chờ trả lời</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-question-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-2">Chưa có câu hỏi nào.</p>
                        <a href="{% url 'ask_question' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> Đặt câu hỏi đầu tiên
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Health Insights Row -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Thông tin sức khỏe</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-heartbeat fa-3x text-danger mb-3"></i>
                            <h6>Theo dõi sức khỏe</h6>
                            <p class="text-muted">Ghi nhận triệu chứng và tình trạng sức khỏe hàng ngày</p>
                            <button class="btn btn-outline-danger" onclick="openSymptomTracker()">
                                <i class="fas fa-plus"></i> Ghi nhận
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-pills fa-3x text-info mb-3"></i>
                            <h6>Nhắc uống thuốc</h6>
                            <p class="text-muted">Thiết lập lời nhắc cho việc uống thuốc đúng giờ</p>
                            <button class="btn btn-outline-info" onclick="setupMedicationReminder()">
                                <i class="fas fa-bell"></i> Thiết lập
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-file-medical fa-3x text-success mb-3"></i>
                            <h6>Hồ sơ y tế</h6>
                            <p class="text-muted">Xem và cập nhật thông tin hồ sơ y tế cá nhân</p>
                            <a href="{% url 'edit_patient_profile' %}" class="btn btn-outline-success">
                                <i class="fas fa-edit"></i> Cập nhật
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <h6 class="mb-3">Thao tác nhanh</h6>
        <div class="btn-group" role="group" aria-label="Quick actions">
            <a href="{% url 'patient_appointments' %}" class="btn btn-outline-primary">
                <i class="fas fa-calendar-alt"></i> Xem lịch hẹn
            </a>
            <a href="{% url 'book_appointment' %}" class="btn btn-outline-success">
                <i class="fas fa-plus"></i> Đặt lịch mới
            </a>
            <button class="btn btn-outline-warning" onclick="openDiseasePrediction()">
                <i class="fas fa-brain"></i> Dự đoán bệnh
            </button>
            <a href="{% url 'chatbot:chat_interface' %}" class="btn btn-outline-info">
                <i class="fas fa-robot"></i> Trợ lý ảo
            </a>
            <a href="{% url 'qa_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-question-circle"></i> Hỏi đáp
            </a>
        </div>
    </div>
</div>

<!-- Health Tips Alert -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-lightbulb fa-2x me-3"></i>
                <div>
                    <h6 class="alert-heading">Mẹo sức khỏe hôm nay</h6>
                    <p class="mb-0">Uống đủ 2-3 lít nước mỗi ngày để duy trì sự hydrat hóa tốt cho cơ thể. 
                    Hãy sử dụng tính năng <strong>Dự đoán bệnh AI</strong> nếu bạn có bất kỳ triệu chứng nào!</p>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<script>
function openDiseasePrediction() {
    // Redirect to chatbot with disease prediction focus
    window.location.href = "{% url 'chatbot:chat_interface' %}?action=disease_prediction";
}

function openSymptomTracker() {
    // Open chatbot for symptom tracking
    window.location.href = "{% url 'chatbot:chat_interface' %}?action=symptom_tracking";
}

function setupMedicationReminder() {
    alert('Tính năng nhắc uống thuốc sẽ được phát triển trong phiên bản tiếp theo!');
}

// Auto-focus disease prediction if URL parameter exists
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('from') === 'prediction') {
        // Show success message for returning from prediction
        setTimeout(() => {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> Bạn đã sử dụng tính năng dự đoán bệnh! 
                Hãy đặt lịch hẹn với bác sĩ nếu cần tư vấn thêm.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
        }, 500);
    }
});

// Add hover effects to cards
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
});
</script>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-group .btn {
    margin: 0 2px;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        margin: 2px 0;
        border-radius: 0.375rem !important;
    }
}

.list-group-item {
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}